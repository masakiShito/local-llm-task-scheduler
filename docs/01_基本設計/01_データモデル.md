# 基本設計書：データモデル（MVP）

## 1. 本書の目的

本書は、本システム（MVP）で扱うデータの構造を定義する。
以降の ER 図、API 設計、スケジューリング仕様、DB 実装（マイグレーション）の前提とする。

---

## 2. 設計方針

### 2.1 再現性の担保

- 計画生成（Plan）は必ず保存する
- Plan を保存することで「いつ・どの条件で・何が生成されたか」を再現可能にする

### 2.2 ロジック主導

- スケジューリングの割当・制約判定はバックエンドのロジックで行う
- LLM は説明生成のみで、データモデル上は Plan に紐づく副次情報として保持する

### 2.3 将来拡張を阻害しない

- Phase1.5 以降（ブロックロック・再生成・週最適化）を見据え、PlanBlock を独立エンティティとして保持する
- ただし MVP では「編集機能」は必須としない

---

## 3. エンティティ一覧（概念モデル）

| エンティティ | 概要                           | 主な用途            |
| ------------ | ------------------------------ | ------------------- |
| Task         | Todo/作業タスクの情報          | 計画生成の入力      |
| Event        | 固定予定（会議など）           | 空き時間算出の入力  |
| Plan         | 対象日の計画（生成結果の単位） | 再現性・履歴        |
| PlanBlock    | 計画内の時間割ブロック         | UI 表示・将来の編集 |

---

## 4. 各エンティティ定義

## 4.1 Task（タスク）

### 4.1.1 概要

ユーザーが管理するタスク情報。Todo と計画タスクを統合して扱う。

### 4.1.2 属性

| 項目名            | 型          | 必須 | 説明                       | 例                        |
| ----------------- | ----------- | ---: | -------------------------- | ------------------------- |
| id                | UUID        |    ○ | タスク ID                  | "..."                     |
| title             | string      |    ○ | タイトル                   | "レポート作成"            |
| description       | string      |    - | 詳細説明                   | "章立て..."               |
| type              | enum        |    ○ | 種別（todo/task）          | "task"                    |
| status            | enum        |    ○ | 状態（open/done/archived） | "open"                    |
| priority          | int         |    ○ | 優先度（1..5）             | 5                         |
| estimate_minutes  | int         |    ○ | 想定工数（分）             | 120                       |
| due_at            | datetime    |    - | 期限                       | 2026-01-10T23:59:00+09:00 |
| available_from    | datetime    |    - | 開始可能                   | 2026-01-10T09:00:00+09:00 |
| available_to      | datetime    |    - | 終了制限                   | 2026-01-10T18:00:00+09:00 |
| splittable        | bool        |    ○ | 分割可否                   | true                      |
| min_block_minutes | int         |    ○ | 最小ブロック長（分）       | 25                        |
| tags              | json(array) |    ○ | タグ配列                   | ["dev","writing"]         |
| created_at        | datetime    |    ○ | 作成日時                   | -                         |
| updated_at        | datetime    |    ○ | 更新日時                   | -                         |

### 4.1.3 制約（バリデーション）

- priority は 1..5
- estimate_minutes は 0 以上
- available_from と available_to が両方ある場合、available_from <= available_to
- min_block_minutes は 5..180（推奨）
- due_at がある場合、due_at は available_from より前でもよい（警告対象になり得る）

---

## 4.2 Event（固定予定）

### 4.2.1 概要

会議・外出など「作業を割り当てられない時間」を表す。空き時間算出の入力として使用する。

### 4.2.2 属性

| 項目名     | 型       | 必須 | 説明           | 例                        |
| ---------- | -------- | ---: | -------------- | ------------------------- |
| id         | UUID     |    ○ | 予定 ID        | "..."                     |
| title      | string   |    ○ | タイトル       | "定例 MTG"                |
| start_at   | datetime |    ○ | 開始           | 2026-01-10T10:00:00+09:00 |
| end_at     | datetime |    ○ | 終了           | 2026-01-10T11:00:00+09:00 |
| locked     | bool     |    ○ | 変更不可フラグ | true                      |
| created_at | datetime |    ○ | 作成日時       | -                         |
| updated_at | datetime |    ○ | 更新日時       | -                         |

### 4.2.3 制約（バリデーション）

- start_at < end_at

---

## 4.3 Plan（計画）

### 4.3.1 概要

対象日ごとに生成された計画の単位。生成条件と結果を保存し、再現性を担保する。

### 4.3.2 属性

| 項目名     | 型       | 必須 | 説明                       | 例               |
| ---------- | -------- | ---: | -------------------------- | ---------------- |
| id         | UUID     |    ○ | 計画 ID                    | "..."            |
| date       | date     |    ○ | 対象日                     | 2026-01-10       |
| timezone   | string   |    ○ | タイムゾーン               | "Asia/Tokyo"     |
| params     | json     |    ○ | 生成パラメータ（入力条件） | working_hours 等 |
| summary    | json     |    - | LLM 説明（JSON）           | summary/why...   |
| created_at | datetime |    ○ | 作成日時                   | -                |
| updated_at | datetime |    ○ | 更新日時                   | -                |

### 4.3.3 params（例）

- working_hours（作業可能時間帯）
- constraints（break/focus/buffer）

例：

```json
{
  "working_hours": [
    { "start": "09:00", "end": "12:00" },
    { "start": "13:00", "end": "18:00" }
  ],
  "constraints": {
    "break_minutes": 10,
    "focus_max_minutes": 90,
    "buffer_ratio": 0.1
  }
}
```

---

## 4.4 PlanBlock（計画ブロック）

### 4.4.1 概要

計画内の時間割の最小単位。work/break/buffer を表現する。

### 4.4.2 属性

| 項目名     | 型       | 必須 | 説明                      | 例                        |
| ---------- | -------- | ---: | ------------------------- | ------------------------- |
| id         | UUID     |    ○ | ブロック ID               | "..."                     |
| plan_id    | UUID     |    ○ | 計画 ID（FK）             | "..."                     |
| task_id    | UUID     |    - | タスク ID（FK）           | "..."                     |
| start_at   | datetime |    ○ | 開始                      | 2026-01-10T09:00:00+09:00 |
| end_at     | datetime |    ○ | 終了                      | 2026-01-10T10:30:00+09:00 |
| kind       | enum     |    ○ | 種別（work/break/buffer） | "work"                    |
| locked     | bool     |    ○ | ユーザー固定              | false                     |
| meta       | json     |    ○ | 理由・スコア等            | {"reason":"due_soon"}     |
| created_at | datetime |    ○ | 作成日時                  | -                         |
| updated_at | datetime |    ○ | 更新日時                  | -                         |

### 4.4.3 制約（バリデーション）

- start_at < end_at
- kind が break/buffer の場合、task_id は null を許容する
- 同一 plan 内でブロックが重複しない（アプリ側で担保）

---

## 5. リレーション定義

- Plan（1）: PlanBlock（N）
- Task（1）: PlanBlock（N） ※ work のみ
- Event は Plan と直接リレーションしない（生成時に参照する入力）

---

## 6. インデックス（推奨）

### tasks

- status
- due_at
- priority

### events

- start_at
- end_at

### plans

- date

### plan_blocks

- plan_id + start_at

---

## 7. MVP で保存しない情報（割り切り）

- 生成時に参照したイベント ID 一覧（必要なら params に含めることで代替可能）
- 詳細なスコアリングの全要素（必要最低限のみ meta に保持）
- ユーザーアカウント情報（単一ユーザー想定）

---

## 8. 次工程への引き渡し

- 本データモデルを前提に ER 図を確定する
- API 設計（CRUD/生成）における入出力項目を整合させる
- DB 実装（SQLAlchemy models / Alembic migration）へ落とし込む
