# 基本設計書：エラー・メッセージ方針（UI 表示ルール）※MVP

## 1. 本書の目的

本書は、本システムにおけるエラーおよびメッセージの表示ルールを定義し、
ユーザー体験の一貫性と、画面実装・API 実装・テスト実装の基準を統一することを目的とする。

---

## 2. 基本方針

- ユーザーに技術的詳細（スタックトレース、例外名）は表示しない
- 失敗を断定する文言を避け、次の行動が分かる表現とする
- 生成結果は「提案」であり、ユーザーの判断を妨げない表現とする
- 同一の事象は同一の見せ方・同一の文言で表示する

---

## 3. メッセージ種別

- 情報（Info）：操作完了や案内
- 注意（Warning）：処理は完了しているが注意が必要（例：overflow 発生）
- エラー（Error）：処理を完了できない（例：入力不正、サーバ障害）

---

## 4. 画面表示ルール

### 4.1 表示位置

- フォーム入力エラー：該当入力項目の直下に表示する
- 画面全体エラー：画面上部にアラートとして表示する
- 一時的な完了通知：画面右上または画面上部にトーストとして表示する
- 計画生成の warnings / overflow：計画詳細画面内に専用セクションで表示する

### 4.2 表示色（画面標準仕様に準拠）

- Info：Text Secondary を基調とする
- Warning：Warning カラーを使用する
- Error：Danger カラーを使用する

---

## 5. HTTP ステータス別の UI 挙動

### 5.1 400 Bad Request（入力不正）

- 原因：必須不足、型不正、範囲不正、整合性不正
- UI 挙動
  - 入力項目に紐づく場合：該当項目直下に表示
  - 全体に関わる場合：画面上部に表示
- 画面遷移：遷移しない（入力画面に留まる）

### 5.2 404 Not Found（対象なし）

- 原因：存在しない ID を参照
- UI 挙動：画面上部にエラーメッセージを表示し、一覧への導線を提供する
- 画面遷移：詳細画面の場合、一覧画面へ戻る導線を表示する

### 5.3 409 Conflict（競合）

- MVP では原則使用しない
- 将来、同時編集・ロックを導入する場合に使用する

### 5.4 500 Internal Server Error（サーバ内部障害）

- 原因：予期しない例外、DB 障害等
- UI 挙動：画面上部にエラーメッセージを表示し、再試行導線を提供する
- 技術情報：ログにのみ出力する（画面表示しない）

---

## 6. 計画生成（/plans/generate）における特則

### 6.1 overflow（未割当）発生時

- 処理結果：成功（200）として扱う
- UI 挙動：計画詳細画面で overflow セクションを表示する
- メッセージ種別：Warning として扱う

### 6.2 warnings（警告）発生時

- 処理結果：成功（200）として扱う
- UI 挙動：計画詳細画面で warnings セクションを表示する
- メッセージ種別：Warning として扱う

### 6.3 LLM 説明生成に失敗した場合

- 処理結果：成功（200）として扱う
- UI 挙動：計画詳細画面で「説明を生成できなかった」旨を表示する
- 生成結果：summary は null または空オブジェクトとして扱う
- 付随情報：warnings に「説明生成が利用できない」旨を含める

---

## 7. 文言ルール（トーン&マナー）

- 命令形を使用しない
- 不安を煽る表現を使用しない
- ユーザーの次の行動が分かる文言とする

---

## 8. 標準メッセージ定義（ID 付き）※MVP

### 8.1 設計方針

- メッセージは message_id（不変）と default_message（文言）を分離する
- API は message_id を返却し、UI は message_id に対応する文言を表示する
- default_message は表示の既定値であり、将来の多言語化・文言調整に備える
- message_id は種別ごとに命名規則を統一する

### 8.2 命名規則

- INFO：`I-XXXX`
- WARNING：`W-XXXX`
- ERROR：`E-XXXX`

---

### 8.3 メッセージ一覧（MVP）

| message_id | 種別    | default_message                                            | 主な表示箇所            | 発生契機（要点）                  |
| ---------- | ------- | ---------------------------------------------------------- | ----------------------- | --------------------------------- |
| I-0001     | Info    | タスクを作成しました                                       | トースト                | POST /tasks 成功                  |
| I-0002     | Info    | タスクを更新しました                                       | トースト                | PATCH /tasks/{task_id} 成功       |
| I-0003     | Info    | タスクを削除しました                                       | トースト                | DELETE /tasks/{task_id} 成功      |
| I-0101     | Info    | 固定予定を作成しました                                     | トースト                | POST /events 成功                 |
| I-0102     | Info    | 固定予定を更新しました                                     | トースト                | PATCH /events/{event_id} 成功     |
| I-0103     | Info    | 固定予定を削除しました                                     | トースト                | DELETE /events/{event_id} 成功    |
| I-0201     | Info    | 計画を生成しました                                         | トースト                | POST /plans/generate 成功         |
| W-0201     | Warning | 本日の空き時間に収まらないタスクがあります                 | 計画詳細（SCR-402/403） | overflow が 1 件以上              |
| W-0202     | Warning | 期限に間に合わない可能性があります                         | 計画詳細（SCR-402/403） | warnings に期限系の警告が含まれる |
| W-0203     | Warning | 計画の説明を生成できませんでした                           | 計画詳細（SCR-402/403） | LLM summary 生成失敗              |
| E-0400     | Error   | 入力内容を確認してください                                 | 画面上部/項目直下       | 400（入力不正）                   |
| E-0404     | Error   | 対象のデータが見つかりませんでした                         | 画面上部                | 404（対象なし）                   |
| E-0500     | Error   | 処理を完了できませんでした。時間をおいて再度お試しください | 画面上部                | 500（サーバ障害）                 |

---

## 9. API レスポンスへの適用（要点）

### 9.1 エラー時（400/404/500）

- レスポンスは `message_id` を必須で含む
- 入力項目単位のエラーは `field_errors` を含む

### 9.2 計画生成時（200）

- warnings / overflow の要素は `message_id` で表現する
- UI は message_id の文言を表示し、必要に応じて詳細情報（対象タスク等）を併記する
