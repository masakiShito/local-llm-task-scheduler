# 基本設計書：アーキテクチャ概要（MVP）

## 1. 本書の目的

本書は、本システムの MVP における全体アーキテクチャ（構成・責務分担・データの流れ）を定義し、
以降の基本設計（ER 図・画面遷移）および詳細設計（API 設計・スケジューリング仕様）における前提を揃えることを目的とする。

---

## 2. アーキテクチャ方針（重要）

### 2.1 責務分離（AI に丸投げしない）

- **スケジューリング（割当）はロジックで担保**する（再現性・テスト可能性を優先）
- LLM は以下に限定する
  - 生成結果の説明（自然言語化）
  - overflow の理由付けと代案提示（入力事実の範囲内）
  - タスク分割案の提案（任意）

### 2.2 再現性の担保

- 計画（Plan）は必ず保存し、同一条件で再実行可能であること
- LLM 出力は副次情報として扱い、失敗しても計画生成（ロジック）を継続する

### 2.3 出力形式の統一

- 生成結果は **JSON（blocks / overflow / warnings）** を必須とする
- LLM 出力は **JSON スキーマ固定** とし、スキーマ検証を行う

---

## 3. システム構成（MVP）

### 3.1 コンポーネント

- Frontend：Next.js（UI）
- Backend：FastAPI（API・スケジューリング・LLM 連携）
- DB：PostgreSQL（Task/Event/Plan 保存）
- Local LLM：Ollama（計画説明生成）

### 3.2 構成図

```mermaid
flowchart LR
    subgraph Client["クライアント"]
      FE["Frontend (Next.js)\n- 画面表示\n- 入力フォーム\n- API呼び出し"]
    end

    subgraph Server["サーバ"]
      BE["Backend (FastAPI)\n- CRUD API\n- 計画生成\n- LLM連携\n- バリデーション"]
      SCHED["Scheduler (ロジック)\n- 空き時間抽出\n- Greedy割当\n- break/buffer\n- overflow/warnings"]
      LLM["Local LLM (Ollama)\n- 説明生成(JSON)"]
    end

    subgraph DB["データベース"]
      PG["PostgreSQL\n- tasks\n- events\n- plans\n- plan_blocks"]
    end

    FE -->|HTTP/JSON| BE
    BE --> SCHED
    SCHED --> BE
    BE -->|SQL| PG
    PG --> BE
    BE -->|HTTP (localhost)| LLM
    LLM -->|JSON| BE
```

---

## 4. 処理の全体フロー

### 4.1 CRUD（タスク・固定予定）

- フロントから CRUD 操作を行う
- バックエンドはバリデーションを行い、DB へ保存する
- 返却値はフロント表示用の JSON

### 4.2 計画生成（最重要）

計画生成は「ロジック主導」で実行し、LLM は後段で説明を作る。

#### 生成の流れ（概略）

1. フロントが対象日と生成条件（working_hours / constraints）を指定して生成 API を呼ぶ
2. バックエンドが未完了 Task と対象日の Event を取得する
3. Scheduler が空き時間スロットを生成し、タスク割当を実行する
4. 計画（Plan / PlanBlocks / overflow / warnings）を DB へ保存する
5. （任意）LLM で説明文（summary 等）を生成し、Plan.summary へ保存する
6. フロントへ最終レスポンスを返す（LLM 失敗時も返す）

---

## 5. 設計上の重要ルール

### 5.1 事実の境界（LLM に渡すデータ）

- LLM に渡す情報は 入力データと生成結果のみ
- 推測で補完させない（捏造防止）
- LLM 出力は必ず JSON スキーマ検証する

### 5.2 エラー・フォールバック

- **スケジューリングに失敗した場合**
  - 入力不正：400（validation error）
  - 例外：500（internal error）
- **LLM に失敗した場合**
  - 計画生成は成功として返す
  - summary は null または固定文（「説明生成に失敗」）で返す

### 5.3 テスト方針（最低限）

- Scheduler はユニットテストで検証する
  - 期限優先が守られる
  - break が挿入される
  - overflow が正しく出る
  - バッファが残る

---

## 6. 主要データの流れ（入出力）

### 6.1 Scheduler 入力（例）

- working_hours
- events（固定予定）
- tasks（未完了）
- constraints（break/focus/buffer）

### 6.2 Scheduler 出力（例）

- blocks（PlanBlocks）
- overflow
- warnings

### 6.3 LLM 入力（例）

- date / timezone
- blocks（表示用に整形した情報）
- overflow（理由つき）
- constraints

### 6.4 LLM 出力（固定 JSON）

- summary（文字列）
- why_this_order（配列）
- warnings（配列）
- overflow_plan（配列）

---

## 7. 次工程への引き渡し

本書を前提として、以下を基本設計にて確定する。

- ER 図（Task/Event/Plan/PlanBlock）
- 画面遷移図（一覧・編集・生成・表示）

また、詳細設計にて以下を確定する。

- API 設計（エンドポイント・I/O・エラー）
- スケジューリング仕様（ルール・優先度・分割・休憩・バッファ）
- テスト方針（ユニットテストケース）
