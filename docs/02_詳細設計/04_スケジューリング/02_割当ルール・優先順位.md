# 詳細設計：割当ルール・優先順位（MVP）

## 1. 本書の目的

割当順序とブロック生成ルールを明確にし、実装とテストの基準を統一する。

---

## 2. 空き時間スロットの生成ルール

### 2.1 生成手順

1. working_hours を datetime（対象日 + timezone）に変換する
2. events（固定予定）を対象日上に配置し、作業不可区間として扱う
3. working_hours から events を差し引き、空き時間スロット配列を生成する

### 2.2 差し引きルール

- event が working_hours と重ならない場合は無視する
- event が一部重なる場合は重なる部分のみ差し引く
- event によりスロットが分割される場合は分割して保持する
- 5 分未満のスロットは破棄する

---

## 3. タスクの対象判定ルール

### 3.1 status

- status=open のみを対象とする
- done / archived は対象外

### 3.2 available_from / available_to

- available_from が存在し、対象日より未来の場合は対象外
- available_to が存在し、対象日より過去の場合は対象外
- 対象外となったタスクは overflow に追加する
  - reason: out_of_availability_window

---

## 4. タスクの並び順（優先順位）

### 4.1 スコアリング方針

タスクを以下のキーでソートし、上から順に割当する。

1. 締切が当日以内（due_at が存在し、対象日中に期限を迎える）
2. 締切が近い（due_at が存在するタスク）
3. 優先度が高い（priority が高い）
4. 想定工数が大きい（estimate_minutes が大きい）

### 4.2 具体的な並び替えルール（決定論）

- due_at があるタスクを due_at 昇順
- due_at がないタスクを後ろに
- 同一 due_at の場合 priority 降順
- 同一 priority の場合 estimate_minutes 降順
- それでも同一の場合 task_id 昇順

---

## 5. 割当ルール（Greedy）

### 5.1 基本

- 並べ替えしたタスクを先頭から処理し、空き時間スロットへ順番に詰める
- 詰める単位は「work ブロック」
- focus_max_minutes を超える連続作業が発生しないよう break を挿入する

### 5.2 分割ルール

- splittable=false の場合
  - タスクは 1 ブロックでのみ割当可能
  - 収まるスロットが存在しない場合 overflow
    - reason: not_enough_continuous_time
- splittable=true の場合
  - min_block_minutes 単位で分割して割当可能
  - タスク残量が min_block_minutes 未満になった場合
    - 余りを切り上げず、割当不可として overflow に残す
    - reason: remaining_too_small

---

## 6. break 挿入ルール

### 6.1 条件

- 連続する work ブロックの累計が focus_max_minutes を超える直前に break を入れる
- break の長さは break_minutes

### 6.2 break の扱い

- break は空き時間スロット内に配置する
- break を置く余地がない場合
  - break をスキップする
  - warnings に追加する
    - message_id: W-0210
    - message: 休憩を確保できませんでした

---

## 7. buffer の生成ルール

### 7.1 方針

- buffer_ratio に基づき「総作業可能時間」の一部をバッファとして確保する
- バッファは原則として「最後」に配置する

### 7.2 算出

- 総作業可能時間（分） = working_hours 合計 - events 重複分
- buffer_minutes = floor(総作業可能時間（分） \* buffer_ratio)

### 7.3 配置

- 最後の空き時間スロット末尾から buffer_minutes を確保する
- buffer を確保できない場合
  - buffer を 0 として扱う
  - warnings に追加する
    - message_id: W-0211
    - message: バッファを確保できませんでした

---

## 8. overflow の判定

- タスク残量が 0 にならず、空き時間が尽きた場合 overflow
  - reason: not_enough_free_time

---

## 9. meta の方針（最小）

- MVP では meta は空オブジェクト {} を返却する
- 将来拡張で以下を格納可能とする
  - score
  - assigned_rule
  - split_count
