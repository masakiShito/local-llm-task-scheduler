# 詳細設計：テーブル制約設計（FK / NOT NULL / UNIQUE）（MVP）

## 1. 本書の目的

本書は、各テーブルに設定する制約（外部キー・NOT NULL・UNIQUE・CHECK）を明確にし、
データ不整合を **DB レベルで防止** することを目的とする。

アプリケーションロジックに依存せず、
「DB に入った時点で正しい状態」を保証する。

---

## 2. 制約設計の基本方針

- **必須項目は NOT NULL で表現する**
- **関連は必ず FK 制約で表現する**
- 削除時の挙動は **ON DELETE を明示する**
- 業務ロジックで変動する条件は CHECK 制約に入れない
- MVP では UNIQUE 制約は最小限とする

---

## 3. tasks テーブル制約

### 3.1 主キー

- task_id
  - PRIMARY KEY

### 3.2 NOT NULL 制約

- task_id
- title
- type
- status
- priority
- estimate_minutes
- created_at
- updated_at

### 3.3 CHECK 制約

- priority：1〜5
- estimate_minutes：5〜1440
- type：todo / task
- status：open / done / archived

### 3.4 UNIQUE 制約

- なし（MVP）

理由

- タイトル重複を許容する
- ユーザー単位制約が未導入のため

---

## 4. events テーブル制約

### 4.1 主キー

- event_id
  - PRIMARY KEY

### 4.2 NOT NULL 制約

- event_id
- title
- start_at
- end_at
- locked
- created_at
- updated_at

### 4.3 CHECK 制約

- locked = true（MVP 固定）

※ DB での CHECK 制約は任意  
※ 実装上はアプリ側で true 固定として扱う

### 4.4 UNIQUE 制約

- なし

---

## 5. plans テーブル制約

### 5.1 主キー

- plan_id
  - PRIMARY KEY

### 5.2 NOT NULL 制約

- plan_id
- date
- timezone
- params
- created_at
- updated_at

### 5.3 CHECK 制約

- timezone：Asia/Tokyo（MVP）

※ 将来拡張時に削除予定

### 5.4 UNIQUE 制約

- なし（MVP）

理由

- 同一日に複数 Plan 生成を許容する設計のため

---

## 6. plan_blocks テーブル制約

### 6.1 主キー

- block_id
  - PRIMARY KEY

### 6.2 NOT NULL 制約

- block_id
- plan_id
- start_at
- end_at
- kind
- created_at

### 6.3 CHECK 制約

- kind：work / break / buffer
- start_at < end_at

### 6.4 外部キー制約（FK）

#### plans → plan_blocks

- plan_blocks.plan_id → plans.plan_id
- ON DELETE CASCADE
- ON UPDATE RESTRICT

理由

- Plan 削除時に PlanBlock を必ず削除する
- plan_id の変更は許可しない

#### tasks → plan_blocks（任意）

- plan_blocks.task_id → tasks.task_id
- ON DELETE SET NULL
- ON UPDATE RESTRICT

理由

- task 削除後も過去 Plan を参照可能にする
- 表示用 task_title は null 許容

---

## 7. 外部キー設計まとめ

| 子テーブル  | 親テーブル | カラム  | ON DELETE | 理由        |
| ----------- | ---------- | ------- | --------- | ----------- |
| plan_blocks | plans      | plan_id | CASCADE   | Plan と一体 |
| plan_blocks | tasks      | task_id | SET NULL  | 履歴保持    |

---

## 8. インデックス設計（制約と併用）

| テーブル    | カラム   | 種別  | 目的      |
| ----------- | -------- | ----- | --------- |
| tasks       | status   | INDEX | open 抽出 |
| tasks       | due_at   | INDEX | 期限順    |
| events      | start_at | INDEX | 日付検索  |
| events      | end_at   | INDEX | 日付検索  |
| plans       | date     | INDEX | 一覧      |
| plan_blocks | plan_id  | INDEX | 取得      |

---

## 9. 禁止事項

- 外部キー制約を張らない実装
- アプリ側だけで整合性を保証する設計
- ON DELETE 未指定の FK

---

## 10. テスト観点（制約）

- plan_blocks.plan_id が存在しない場合 INSERT できないこと
- task 削除時に plan_blocks.task_id が null になること
- plans 削除時に plan_blocks が全削除されること
- CHECK 制約違反時に INSERT が失敗すること
