# 詳細設計：永続化・トランザクション 概要（MVP）

## 1. 本書の目的

本書は、本システムにおけるデータ永続化方針およびトランザクション制御方針を定義し、
データ不整合の防止・再現性の担保・実装指針の明確化を目的とする。

---

## 2. 基本方針

- データの永続化は **RDB（PostgreSQL）** を前提とする
- 書き込み処理はすべてトランザクション管理下で行う
- 「生成系 API」は必ず **一貫性のある状態で完了 or ロールバック** される
- 中間状態は DB に残さない

---

## 3. 永続化対象エンティティ

| エンティティ | 永続化単位  | 備考             |
| ------------ | ----------- | ---------------- |
| Task         | 単体        | CRUD 単位        |
| Event        | 単体        | CRUD 単位        |
| Plan         | 集約ルート  | PlanBlock を内包 |
| PlanBlock    | Plan に従属 | 単独 CRUD なし   |

---

## 4. トランザクション境界の原則

### 4.1 単体 CRUD API

- 対象：Task / Event
- 原則：1 API = 1 トランザクション
- 失敗時は即時ロールバック

### 4.2 集約操作 API

- 対象：POST /plans/generate
- Plan + PlanBlock を **同一トランザクション** で保存する

---

## 5. POST /plans/generate のトランザクション設計

### 5.1 トランザクション範囲

以下を **単一トランザクション** とする。

1. Plan レコード作成
2. PlanBlock レコード一括作成
3. Plan の summary 更新（LLM 成功時）

### 5.2 成功条件

- Plan が 1 件作成されている
- PlanBlock が 0 件以上作成されている
- DB 上に不整合な外部キーが存在しない

### 5.3 ロールバック条件

- PlanBlock 作成失敗
- DB 制約違反（FK / NOT NULL / 型不正）
- 予期しない例外発生

※ LLM による summary 生成失敗は **ロールバック対象外** とする

---

## 6. LLM 連携時の永続化方針

### 6.1 処理順序

1. スケジューリング結果生成
2. Plan / PlanBlock 永続化（commit）
3. LLM による summary 生成
4. summary の更新（別トランザクション）

### 6.2 理由

- 外部要因（LLM 失敗）により計画生成を失敗させないため
- スケジューリング結果の再現性を担保するため

---

## 7. Plan の不変性（Immutable 方針）

- Plan は生成後に内容を変更しない
- 修正が必要な場合は **再生成（新 Plan 作成）** とする
- DELETE は論理削除ではなく物理削除とする（MVP）

---

## 8. 排他制御方針（MVP）

- 単一ユーザー前提のため、楽観ロックは導入しない
- 同一日付の Plan を複数生成することは許容する
- 将来拡張時に以下を検討する
  - date + user_id の一意制約
  - version カラムによる楽観ロック

---

## 9. トランザクション分離レベル

- DB 分離レベル：READ COMMITTED
- 想定問題
  - ダーティリード：発生しない
  - ノンリピータブルリード：許容
  - ファントムリード：MVP では許容

---

## 10. 禁止事項

- トランザクションを跨いだ部分的な Plan 保存
- PlanBlock 単体の直接更新・削除
- LLM 失敗を理由に Plan 生成を失敗させる実装

---

## 11. テスト観点（永続化）

- Plan 生成失敗時に Plan / PlanBlock が残らないこと
- summary=null の Plan が正常取得できること
- overflow / warnings が DB 保存結果に影響しないこと
- 同日複数 Plan 生成時にデータ競合が起きないこと
